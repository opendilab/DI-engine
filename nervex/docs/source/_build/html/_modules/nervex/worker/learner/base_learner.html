

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>nervex.worker.learner.base_learner &mdash; nerveX 0.2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> nerveX
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../key_concept/index.html">Key Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro_rl/index.html">Introduction to RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hands_on/index.html">Hands on RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../best_practice/index.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../feature/index.html">Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../supplementary_rl/index.html">Supplementary of RL</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial_dev/index.html">Tutorial-Developer</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">nerveX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>nervex.worker.learner.base_learner</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for nervex.worker.learner.base_learner</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Copyright 2020 Sensetime X-lab. All Rights Reserved</span>

<span class="sd">Main Function:</span>
<span class="sd">    1. Base learner class for both serial and parallel training pipeline.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">easydict</span> <span class="kn">import</span> <span class="n">EasyDict</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">nervex.data</span> <span class="kn">import</span> <span class="n">AsyncDataLoader</span><span class="p">,</span> <span class="n">default_collate</span>
<span class="kn">from</span> <span class="nn">nervex.torch_utils</span> <span class="kn">import</span> <span class="n">build_checkpoint_helper</span><span class="p">,</span> <span class="n">CountVar</span><span class="p">,</span> <span class="n">auto_checkpoint</span><span class="p">,</span> <span class="n">build_log_buffer</span>
<span class="kn">from</span> <span class="nn">nervex.utils</span> <span class="kn">import</span> <span class="n">build_logger</span><span class="p">,</span> <span class="n">EasyTimer</span><span class="p">,</span> <span class="n">pretty_print</span><span class="p">,</span> <span class="n">get_task_uid</span><span class="p">,</span> <span class="n">import_module</span><span class="p">,</span> <span class="n">LEARNER_REGISTRY</span><span class="p">,</span> \
    <span class="n">deep_merge_dicts</span><span class="p">,</span> <span class="n">get_rank</span>
<span class="kn">from</span> <span class="nn">nervex.utils.autolog</span> <span class="kn">import</span> <span class="n">LoggedValue</span><span class="p">,</span> <span class="n">LoggedModel</span><span class="p">,</span> <span class="n">NaturalTime</span><span class="p">,</span> <span class="n">TickTime</span><span class="p">,</span> <span class="n">TimeMode</span>
<span class="kn">from</span> <span class="nn">.learner_hook</span> <span class="kn">import</span> <span class="n">build_learner_hook_by_cfg</span><span class="p">,</span> <span class="n">add_learner_hook</span><span class="p">,</span> <span class="n">merge_hooks</span><span class="p">,</span> <span class="n">LearnerHook</span>


<div class="viewcode-block" id="BaseLearner"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner">[docs]</a><span class="nd">@LEARNER_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BaseLearner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overview:</span>
<span class="sd">        Base class for model learning.</span>
<span class="sd">    Interface:</span>
<span class="sd">        train, start, setup_dataloader, close, call_hook, register_hook, save_checkpoint</span>
<span class="sd">    Property:</span>
<span class="sd">        learn_info, priority_info, last_iter, name, rank, policy</span>
<span class="sd">        tick_time, monitor, log_buffer, logger, tb_logger</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">default_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EasyDict</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">EasyDict</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">cfg_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;Dict&#39;</span>
        <span class="k">return</span> <span class="n">cfg</span>

    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">train_iterations</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e9</span><span class="p">),</span>
        <span class="n">dataloader</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="p">),</span>
        <span class="c1"># --- Hooks ---</span>
        <span class="n">hook</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">load_ckpt_before_run</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">log_show_after_iter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">save_ckpt_after_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
            <span class="n">save_ckpt_after_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;BaseLearner&quot;</span>  <span class="c1"># override this variable for sub-class learner</span>

<div class="viewcode-block" id="BaseLearner.__init__"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">cfg</span><span class="p">:</span> <span class="n">EasyDict</span><span class="p">,</span>
            <span class="n">policy</span><span class="p">:</span> <span class="n">namedtuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">tb_logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;SummaryWriter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Init method. Load config and use ``self._cfg`` to build common learner components,</span>
<span class="sd">            e.g. logger, hooks.</span>
<span class="sd">            Policy is not initialized here, but set afterwards through policy setter.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            - cfg (:obj:`EasyDict`): Learner config, you can view `cfg &lt;../../../configuration/index.html&gt;`_ for ref.</span>
<span class="sd">        Notes:</span>
<span class="sd">            If you want to debug in sync CUDA mode, please add the following code at the beginning of ``__init__``.</span>

<span class="sd">            .. code:: python</span>

<span class="sd">                os.environ[&#39;CUDA_LAUNCH_BLOCKING&#39;] = &quot;1&quot;  # for debug async CUDA</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cuda</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ckpt_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># These 3 attributes are only used in parallel mode.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">=</span> <span class="n">get_rank</span><span class="p">()</span>  <span class="c1"># Learner rank. Used to discriminate which GPU it uses.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_learner_done</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Logger (Monitor will be initialized in policy setter)</span>
        <span class="c1"># Only rank == 0 learner needs monitor and tb_logger, others only need text_logger to display terminal output.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="n">EasyTimer</span><span class="p">()</span>
        <span class="n">rank0</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>  <span class="c1"># todo</span>
        <span class="k">if</span> <span class="n">tb_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">build_logger</span><span class="p">(</span><span class="s1">&#39;./log/learner&#39;</span><span class="p">,</span> <span class="s1">&#39;learner&#39;</span><span class="p">,</span> <span class="n">need_tb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tb_logger</span> <span class="o">=</span> <span class="n">tb_logger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tb_logger</span> <span class="o">=</span> <span class="n">build_logger</span><span class="p">(</span><span class="s1">&#39;./log/learner&#39;</span><span class="p">,</span> <span class="s1">&#39;learner&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;scalar&#39;</span><span class="p">:</span> <span class="n">build_log_buffer</span><span class="p">(),</span>
            <span class="s1">&#39;scalars&#39;</span><span class="p">:</span> <span class="n">build_log_buffer</span><span class="p">(),</span>
            <span class="s1">&#39;histogram&#39;</span><span class="p">:</span> <span class="n">build_log_buffer</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pretty_print</span><span class="p">({</span><span class="s2">&quot;learner config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">},</span> <span class="n">direct_print</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="c1"># Learner hooks. Used to do specific things at specific time point. Will be set in ``_setup_hook``</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;before_run&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;before_iter&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;after_iter&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;after_run&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="c1"># Priority info. Used to update replay buffer according to data&#39;s priority.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_priority_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Last iteration. Used to record current iter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_iter</span> <span class="o">=</span> <span class="n">CountVar</span><span class="p">(</span><span class="n">init_val</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Setup policy, time wrapper and hook.</span>
        <span class="k">if</span> <span class="n">policy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_wrapper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_hook</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseLearner._setup_hook"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner._setup_hook">[docs]</a>    <span class="k">def</span> <span class="nf">_setup_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Setup hook for base_learner. Hook is the way to implement some functions at specific time point</span>
<span class="sd">            in base_learner. You can refer to ``learner_hook.py``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_hooks&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="n">merge_hooks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">,</span> <span class="n">build_learner_hook_by_cfg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">hook</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="n">build_learner_hook_by_cfg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">hook</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseLearner._setup_wrapper"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner._setup_wrapper">[docs]</a>    <span class="k">def</span> <span class="nf">_setup_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Use ``_time_wrapper`` to get ``train_time``.</span>
<span class="sd">        Note:</span>
<span class="sd">            ``data_time`` is wrapped in ``setup_dataloader``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper_timer</span> <span class="o">=</span> <span class="n">EasyTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;train_time&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_time_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">var_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Wrap a function and record the time it used in ``_log_buffer``.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            - fn (:obj:`Callable`): Function to be time_wrapped.</span>
<span class="sd">            - var_type (:obj:`str`): Variable type, e.g. [&#39;scalar&#39;, &#39;scalars&#39;, &#39;histogram&#39;].</span>
<span class="sd">            - var_name (:obj:`str`): Variable name, e.g. [&#39;cur_lr&#39;, &#39;total_loss&#39;].</span>
<span class="sd">        Returns:</span>
<span class="sd">             - wrapper (:obj:`Callable`): The wrapper to acquire a function&#39;s time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper_timer</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="p">[</span><span class="n">var_type</span><span class="p">][</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper_timer</span><span class="o">.</span><span class="n">value</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">return</span> <span class="n">wrapper</span>

<div class="viewcode-block" id="BaseLearner.register_hook"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner.register_hook">[docs]</a>    <span class="k">def</span> <span class="nf">register_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">:</span> <span class="n">LearnerHook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Add a new learner hook.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            - hook (:obj:`LearnerHook`): The hook to be addedr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">add_learner_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseLearner.train"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">envstep</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Given training data, implement network update for one iteration and update related variables.</span>
<span class="sd">            Learner&#39;s API for serial entry.</span>
<span class="sd">            Also called in ``start`` for each iteration&#39;s training.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            - data (:obj:`dict`): Training data which is retrieved from repaly buffer.</span>

<span class="sd">        .. note::</span>

<span class="sd">            ``_policy`` must be set before calling this method.</span>

<span class="sd">            ``_policy.forward`` method contains: forward, backward, grad sync(if in multi-gpu mode) and</span>
<span class="sd">            parameter update.</span>

<span class="sd">            ``before_iter`` and ``after_iter`` hooks are called at the beginning and ending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_policy&#39;</span><span class="p">),</span> <span class="s2">&quot;please set learner policy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;before_iter&#39;</span><span class="p">)</span>

        <span class="c1"># Forward</span>
        <span class="n">log_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Update replay buffer&#39;s priority info</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="n">log_vars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">priority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">replay_buffer_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;replay_buffer_idx&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="n">replay_unique_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;replay_unique_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_priority_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                <span class="s1">&#39;replay_buffer_idx&#39;</span><span class="p">:</span> <span class="n">replay_buffer_idx</span><span class="p">,</span>
                <span class="s1">&#39;replay_unique_id&#39;</span><span class="p">:</span> <span class="n">replay_unique_id</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="c1"># Discriminate vars in scalar, scalars and histogram type</span>
        <span class="c1"># Regard a var as scalar type by default. For scalars and histogram type, must annotate by prefix &quot;[xxx]&quot;</span>
        <span class="n">scalars_vars</span><span class="p">,</span> <span class="n">histogram_vars</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">log_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s2">&quot;[scalars]&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">new_k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">scalars_vars</span><span class="p">[</span><span class="n">new_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_vars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;[histogram]&quot;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">new_k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">histogram_vars</span><span class="p">[</span><span class="n">new_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_vars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="c1"># Update log_buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="p">[</span><span class="s1">&#39;scalar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">log_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="p">[</span><span class="s1">&#39;scalars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scalars_vars</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="p">[</span><span class="s1">&#39;histogram&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">histogram_vars</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_collector_envstep</span> <span class="o">=</span> <span class="n">envstep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;after_iter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_iter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="nd">@auto_checkpoint</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            [Only Used In Parallel Mode] Learner&#39;s API for parallel entry.</span>
<span class="sd">            For each iteration, learner will get data through ``_next_data`` and call ``train`` to train.</span>

<span class="sd">        .. note::</span>

<span class="sd">            ``before_run`` and ``after_run`` hooks are called at the beginning and ending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_learner_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># before run hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;before_run&#39;</span><span class="p">)</span>

        <span class="n">train_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">train_iterations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_iterations</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_flag</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_learner_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># after run hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;after_run&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BaseLearner.setup_dataloader"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner.setup_dataloader">[docs]</a>    <span class="k">def</span> <span class="nf">setup_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            [Only Used In Parallel Mode] Setup learner&#39;s dataloader.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Only in parallel mode will we use attributes ``get_data`` and ``_dataloader` to fetch data from file system;</span>
<span class="sd">            Instead, in serial version, we can fetch data from memory directly.</span>

<span class="sd">            In parallel mode, ``get_data`` is set by ``LearnerCommHelper``, and should be callable.</span>
<span class="sd">            Users don&#39;t need to know the related details if not necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">dataloader</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">)</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">chunk_size</span> <span class="k">if</span> <span class="s1">&#39;chunk_size&#39;</span> <span class="ow">in</span> <span class="n">cfg</span> <span class="k">else</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span> <span class="o">=</span> <span class="n">AsyncDataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_workers</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span><span class="p">,</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;data_time&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_next_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            [Only Used In Parallel Mode] Call ``_dataloader``&#39;s ``__next__`` method to return next training data.</span>
<span class="sd">        Returns:</span>
<span class="sd">            - data (:obj:`Any`): Next training data from dataloader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span><span class="p">)</span>

<div class="viewcode-block" id="BaseLearner.close"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            [Only Used In Parallel Mode] Close the related resources, e.g. dataloader, tensorboard logger, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_flag</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dataloader&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tb_logger</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tb_logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="BaseLearner.call_hook"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner.call_hook">[docs]</a>    <span class="k">def</span> <span class="nf">call_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Call the corresponding hook plugins according to position name.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            - name (:obj:`str`): Hooks in which position to call, \</span>
<span class="sd">                should be in [&#39;before_run&#39;, &#39;after_run&#39;, &#39;before_iter&#39;, &#39;after_iter&#39;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Log string info by ``self._logger.info``.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            - s (:obj:`str`): The message to add into the logger.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<div class="viewcode-block" id="BaseLearner.save_checkpoint"><a class="viewcode-back" href="../../../../api_doc/worker/learner/learner.html#nervex.worker.learner.base_learner.BaseLearner.save_checkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ckpt_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Directly call ``save_ckpt_after_run`` hook to save checkpoint.</span>
<span class="sd">        Note:</span>
<span class="sd">            Must guarantee that &quot;save_ckpt_after_run&quot; is registered in &quot;after_run&quot; hook.</span>
<span class="sd">            This method is called in:</span>

<span class="sd">                - ``auto_checkpoint`` (``torch_utils/checkpoint_helper.py``), which is designed for \</span>
<span class="sd">                    saving checkpoint whenever an exception raises.</span>
<span class="sd">                - ``serial_pipeline`` (``entry/serial_entry.py``). Used to save checkpoint when reaching \</span>
<span class="sd">                    new highest evaluation reward.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ckpt_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_name</span> <span class="o">=</span> <span class="n">ckpt_name</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="s1">&#39;after_run&#39;</span><span class="p">]]</span>
        <span class="k">assert</span> <span class="s1">&#39;save_ckpt_after_run&#39;</span> <span class="ow">in</span> <span class="n">names</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;save_ckpt_after_run&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="s1">&#39;after_run&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_name</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">learn_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overview:</span>
<span class="sd">            Get current info dict, which will be sent to commander, e.g. replay buffer priority update,</span>
<span class="sd">            current iteration, hyper-parameter adjustment, whether task is finished, etc.</span>
<span class="sd">        Returns:</span>
<span class="sd">            - info (:obj:`dict`): Current learner info dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;learner_step&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_iter</span><span class="o">.</span><span class="n">val</span><span class="p">,</span>
            <span class="s1">&#39;priority_info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority_info</span><span class="p">,</span>
            <span class="s1">&#39;learner_done&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_learner_done</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CountVar</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_iter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">train_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_iter</span><span class="o">.</span><span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tick_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TickTime</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tick_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;TickMonitor&#39;</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>  <span class="c1"># LogDict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span>

    <span class="nd">@log_buffer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">log_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_log_buffer</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span> <span class="o">=</span> <span class="n">_log_buffer</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">logger</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;TextLogger&#39;</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tb_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;TensorBoradLogger&#39;</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tb_logger</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">policy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Policy&#39;</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span>

    <span class="nd">@policy</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_policy</span><span class="p">:</span> <span class="s1">&#39;Policy&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note:</span>
<span class="sd">            Policy variable monitor is set alongside with policy, because variables are determined by specific policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span> <span class="o">=</span> <span class="n">_policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cuda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span> <span class="o">=</span> <span class="n">get_simple_monitor_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">monitor_vars</span><span class="p">())(</span><span class="n">TickTime</span><span class="p">(),</span> <span class="n">expire</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">priority_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority_info</span>

    <span class="nd">@priority_info</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">priority_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_priority_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_priority_info</span> <span class="o">=</span> <span class="n">_priority_info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ckpt_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ckpt_name</span>

    <span class="nd">@ckpt_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ckpt_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_ckpt_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ckpt_name</span> <span class="o">=</span> <span class="n">_ckpt_name</span></div>


<span class="k">def</span> <span class="nf">create_learner</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">EasyDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseLearner</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overview:</span>
<span class="sd">        Given the key(learner_name), create a new learner instance if in learner_mapping&#39;s values,</span>
<span class="sd">        or raise an KeyError. In other words, a derived learner must first register, then can call ``create_learner``</span>
<span class="sd">        to get the instance.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        - cfg (:obj:`EasyDict`): Learner config. Necessary keys: [learner.import_module, learner.learner_type].</span>
<span class="sd">    Returns:</span>
<span class="sd">        - learner (:obj:`BaseLearner`): The created new learner, should be an instance of one of \</span>
<span class="sd">            learner_mapping&#39;s values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">import_module</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;import_names&#39;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">return</span> <span class="n">LEARNER_REGISTRY</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TickMonitor</span><span class="p">(</span><span class="n">LoggedModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overview:</span>
<span class="sd">        TickMonitor is to monitor related info during training.</span>
<span class="sd">        Info includes: cur_lr, time(data, train, forward, backward), loss(total,...)</span>
<span class="sd">        These info variables are firstly recorded in ``log_buffer``, then in ``LearnerHook`` will vars in</span>
<span class="sd">        in this monitor be updated by``log_buffer``, finally printed to ``TextLogger`` and ``TensorBoradLogger``.</span>
<span class="sd">    Interface:</span>
<span class="sd">        __init__, fixed_time, current_time, freeze, unfreeze, register_attribute_value, __getattr__</span>
<span class="sd">    Property:</span>
<span class="sd">        time, expire</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_time</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">train_time</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">total_collect_step</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">total_step</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">total_episode</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">total_sample</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">total_duration</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_</span><span class="p">:</span> <span class="s1">&#39;BaseTime&#39;</span><span class="p">,</span> <span class="n">expire</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>  <span class="c1"># noqa</span>
        <span class="n">LoggedModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_</span><span class="p">,</span> <span class="n">expire</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">__avg_func</span><span class="p">(</span><span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_values</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]()</span>
            <span class="n">_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_value</span> <span class="k">for</span> <span class="p">(</span><span class="n">_begin_time</span><span class="p">,</span> <span class="n">_end_time</span><span class="p">),</span> <span class="n">_value</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">__val_func</span><span class="p">(</span><span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_values</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]()</span>
            <span class="k">return</span> <span class="n">records</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_LoggedModel__properties&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__avg_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__val_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_simple_monitor_type</span><span class="p">(</span><span class="n">properties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">TickMonitor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overview:</span>
<span class="sd">        Besides basic training variables provided in ``TickMonitor``, many policies have their own customized</span>
<span class="sd">        ones to record and monitor. This function can return a customized tick monitor.</span>
<span class="sd">        Compared with ``TickMonitor``, ``SimpleTickMonitor`` can record extra ``properties`` passed in by a policy.</span>
<span class="sd">    Argumenst:</span>
<span class="sd">         - properties (:obj:`List[str]`): Customized properties to monitor.</span>
<span class="sd">    Returns:</span>
<span class="sd">        - simple_tick_monitor (:obj:`SimpleTickMonitor`): A simple customized tick monitor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TickMonitor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;data_time&#39;</span><span class="p">,</span> <span class="s1">&#39;train_time&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_count&#39;</span><span class="p">,</span> <span class="s1">&#39;total_collect_step&#39;</span><span class="p">,</span> <span class="s1">&#39;total_step&#39;</span><span class="p">,</span> <span class="s1">&#39;total_sample&#39;</span><span class="p">,</span>
            <span class="s1">&#39;total_episode&#39;</span><span class="p">,</span> <span class="s1">&#39;total_duration&#39;</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">properties</span>
        <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;SimpleTickMonitor&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">TickMonitor</span><span class="p">,</span> <span class="p">),</span> <span class="n">attrs</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, X-Lab.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>