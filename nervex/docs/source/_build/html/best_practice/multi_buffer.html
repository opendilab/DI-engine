

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>How to use multiple buffers? &mdash; nerveX 0.2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to randomly collect some data sample at the beginning?" href="random_collect_size.html" />
    <link rel="prev" title="How to understand training generated folders?" href="training_generated_folders.html" />
    <link href="../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> nerveX
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concept/index.html">Key Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro_rl/index.html">Introduction to RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hands_on/index.html">Hands on RL</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Best Practice</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nstep_td.html">N-step TD</a></li>
<li class="toctree-l2"><a class="reference internal" href="priority.html">How to Use PER(Prioritized Experience Replay)</a></li>
<li class="toctree-l2"><a class="reference internal" href="log.html">Log and Tensorboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="IL.html">Imitation Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="IRL.html">Inverse RL</a></li>
<li class="toctree-l2"><a class="reference internal" href="rnn.html">How to use RNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="random_seed.html">Random seed</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_discrete.html">Multi-Discrete Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_wrapper.html">How to Customize Model Wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="env_wrapper.html">How to Customize an Env Wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="registry.html">Registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="customization1_dynamic_update_step.html">Customization 1: Dynamic Update Step</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_generated_folders.html">How to understand training generated folders?</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to use multiple buffers?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#guideline">Guideline</a></li>
<li class="toctree-l3"><a class="reference internal" href="#config">1. Config</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pipeline">2. Pipeline</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="random_collect_size.html">How to randomly collect some data sample at the beginning?</a></li>
<li class="toctree-l2"><a class="reference internal" href="irregular_learner_log.html">How to correctly print irregular log?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../feature/index.html">Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supplementary_rl/index.html">Supplementary of RL</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_dev/index.html">Tutorial-Developer</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">nerveX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Best Practice</a> &raquo;</li>
        
      <li>How to use multiple buffers?</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/best_practice/multi_buffer.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-use-multiple-buffers">
<h1>How to use multiple buffers?<a class="headerlink" href="#how-to-use-multiple-buffers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="guideline">
<h2>Guideline<a class="headerlink" href="#guideline" title="Permalink to this headline">¶</a></h2>
<p>In some algorithms, it is required to use multiple buffers. For example, in <a class="reference external" href="https://arxiv.org/pdf/1909.01387.pdf">R2D3</a>, there is a demonstration buffer full of expert data and an agent buffer collected during training; In <a class="reference external" href="https://arxiv.org/pdf/2009.04416.pdf">Phasic Policy Gradient</a>, there is a value buffer and a policy buffer respectively designed for critic optimization and actor optimization.</p>
<p>However, nerveX <cite>serial_pipeline</cite> only supports single buffer. So in this section, we will teach you how to write the configuration file and your own multi-buffer pipeline. We will take <cite>PPG</cite> algorithm as an example.</p>
</div>
<div class="section" id="config">
<h2>1. Config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>We show core part of <cite>nerveX/app_zoo/classic_control/cartpole/config/cartpole_ppg_config.py</cite> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cartpole_ppg_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="n">policy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="c1"># ...</span>
        <span class="n">other</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">replay_buffer</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">multi_buffer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">policy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">replay_buffer_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="c1"># nerveX implemented PPG is not the same as original paper version.</span>
                    <span class="c1"># In nerveX, we utilize `max_use` to control how many times data is used to optimize</span>
                    <span class="c1"># actor and critic network.</span>
                    <span class="n">max_use</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">replay_buffer_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">max_use</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You must set <code class="docutils literal notranslate"><span class="pre">multi_buffer</span></code> to True; Then list all buffers’ configuration.</p>
<p>If you want to use <cite>create_cfg</cite>, you must list all buffers’ type:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cartpole_ppg_create_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="n">replay_buffer</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">policy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;priority&#39;</span><span class="p">),</span>
        <span class="n">value</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;priority&#39;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="pipeline">
<h2>2. Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>After finishing the config file, you can write your own pipeline. Here is an example from <cite>app_zoo/classic_control/cartpole/entry/cartpole_ppg_main.py</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Init two buffers</span>
<span class="n">policy_buffer</span> <span class="o">=</span> <span class="n">AdvancedReplayBuffer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">policy</span><span class="p">,</span> <span class="n">tb_logger</span><span class="p">,</span> <span class="s1">&#39;policy&#39;</span><span class="p">)</span>
<span class="n">value_buffer</span> <span class="o">=</span> <span class="n">AdvancedReplayBuffer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">tb_logger</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># ...</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">train_iter</span><span class="o">=</span><span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">)</span>
    <span class="c1"># Push data into two buffers repectively. If you may change data in buffer, you can deepcopy it.</span>
    <span class="n">policy_buffer</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">cur_collector_envstep</span><span class="o">=</span><span class="n">collector</span><span class="o">.</span><span class="n">envstep</span><span class="p">)</span>
    <span class="n">value_buffer</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">cur_collector_envstep</span><span class="o">=</span><span class="n">collector</span><span class="o">.</span><span class="n">envstep</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">update_per_collect</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">learner</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">)</span>
        <span class="c1"># Sample from two buffers respectively. Form the new `train_data` and start learner training.</span>
        <span class="n">policy_data</span> <span class="o">=</span> <span class="n">policy_buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">batch_size</span><span class="p">[</span><span class="s1">&#39;policy&#39;</span><span class="p">],</span> <span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">)</span>
        <span class="n">value_data</span> <span class="o">=</span> <span class="n">policy_buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">batch_size</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">policy_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;policy&#39;</span><span class="p">:</span> <span class="n">policy_data</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value_data</span><span class="p">}</span>
            <span class="n">learner</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">collector</span><span class="o">.</span><span class="n">envstep</span><span class="p">)</span>
</pre></div>
</div>
<p>There are two issues you should pay attention to:</p>
<blockquote>
<div><ul class="simple">
<li><p>Rewrite policy’s <code class="docutils literal notranslate"><span class="pre">_get_batch_size</span></code> method. Its return should be a dict like <code class="docutils literal notranslate"><span class="pre">{'value':</span> <span class="pre">32,</span> <span class="pre">'policy':</span> <span class="pre">32}</span></code>.</p></li>
<li><p>(Optional) Rewrite policy’s <code class="docutils literal notranslate"><span class="pre">_process_transition</span></code> method. Specify each data which buffer it should be pushed into. In this example, same data are pushed into to two buffers respectively. But you can also push value data into value buffer, and policy data into policy buffer.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="random_collect_size.html" class="btn btn-neutral float-right" title="How to randomly collect some data sample at the beginning?" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="training_generated_folders.html" class="btn btn-neutral float-left" title="How to understand training generated folders?" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, X-Lab.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>