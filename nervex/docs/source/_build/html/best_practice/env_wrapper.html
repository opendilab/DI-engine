

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>How to Customize an Env Wrapper &mdash; nerveX 0.2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Registry" href="registry.html" />
    <link rel="prev" title="How to Customize Model Wrapper" href="model_wrapper.html" />
    <link href="../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> nerveX
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concept/index.html">Key Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro_rl/index.html">Introduction to RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hands_on/index.html">Hands on RL</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Best Practice</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nstep_td.html">N-step TD</a></li>
<li class="toctree-l2"><a class="reference internal" href="priority.html">How to Use PER(Prioritized Experience Replay)</a></li>
<li class="toctree-l2"><a class="reference internal" href="log.html">Log and Tensorboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="IL.html">Imitation Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="IRL.html">Inverse RL</a></li>
<li class="toctree-l2"><a class="reference internal" href="rnn.html">How to use RNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="random_seed.html">Random seed</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_discrete.html">Multi-Discrete Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="model_wrapper.html">How to Customize Model Wrapper</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to Customize an Env Wrapper</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-reason-we-need-to-customize-an-env-wrapper">The reason we need to customize an env wrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#to-customize-an-env-wrapper">To customize an env wrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#to-customize-an-general-env-wrapper">To customize an general env wrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples: </a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="registry.html">Registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="customization1_dynamic_update_step.html">Customization 1: Dynamic Update Step</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_generated_folders.html">How to understand training generated folders?</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_buffer.html">How to use multiple buffers?</a></li>
<li class="toctree-l2"><a class="reference internal" href="random_collect_size.html">How to randomly collect some data sample at the beginning?</a></li>
<li class="toctree-l2"><a class="reference internal" href="irregular_learner_log.html">How to correctly print irregular log?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../feature/index.html">Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supplementary_rl/index.html">Supplementary of RL</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_dev/index.html">Tutorial-Developer</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">nerveX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Best Practice</a> &raquo;</li>
        
      <li>How to Customize an Env Wrapper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/best_practice/env_wrapper.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-customize-an-env-wrapper">
<h1>How to Customize an Env Wrapper<a class="headerlink" href="#how-to-customize-an-env-wrapper" title="Permalink to this headline">Â¶</a></h1>
<p>Env module is one of the most important modules in the domain of reinforcement learnig.
In some common reinforcement learning tasks, for instance, atari, mujoco, we train our agents
to explore and learn in these environments.</p>
<p>Usually, defining an environment needs to start from the input and the output of the environment, and fully
consider possible obervation spaces and action spaces. The module Gym open-sourced by OpenAI has helped us define
most common environments for the use in both academia and industry. NerveX also follows the definition of Gym.env, and
further adds some convenient functions for a better use experience.</p>
<p>Gym.env.wrapper, as a subclass of Gym.wrapper, enables users to facilitate the manipulation or adaptation of the input and output of the environment class.
Wrapper is a very convient and effective tool. Env wrapper only wraps some of the commonly used gym wrappers.</p>
<p>NerveX provides the following env wrappers (Many of which are borrowed from openai baselines):</p>
<ul class="simple">
<li><p>NoopResetEnv. Add reset method for the env. Reset the env after some no-operations.</p></li>
<li><p>MaxAndSkipEnv. Return only every <cite>skip</cite>-th frame (frameskipping) using most
recent raw observations (for max pooling across time steps).</p></li>
<li><p>WarpFrame. Warp frames to 84x84 as done in the Nature paper and later work.</p></li>
<li><p>ScaledFloatFrame. Normalize observations to 0~1.</p></li>
<li><p>ClipRewardEnv. Clips the reward to {+1, 0, -1} by its sign.</p></li>
<li><p>FrameStack. Stack n_frames last frames.</p></li>
<li><p>ObsTransposeWrapper. Wrapper to transpose env, usually used in atari environments</p></li>
<li><p>RunningMeanStd. Wrapper to update new variable, new mean, and new count</p></li>
<li><p>ObsNormEnv. Normalize observations according to running mean and std.</p></li>
<li><p>RewardNormEnv. Normalize reward according to running std.</p></li>
<li><p>RamWrapper. Wrapper ram env into image-like env</p></li>
<li><p>EpisodicLifeEnv. Make end-of-life == end-of-episode, but only reset on true game over. It helps the value estimation.</p></li>
<li><p>FireResetEnv.  Take action on reset for environments that are fixed until firing.</p></li>
<li><p>update_shape. This is a function that helps recognise the shape of observations, actiions
and reward after applying env wrappers.</p></li>
</ul>
<div class="section" id="the-reason-we-need-to-customize-an-env-wrapper">
<h2>The reason we need to customize an env wrapper<a class="headerlink" href="#the-reason-we-need-to-customize-an-env-wrapper" title="Permalink to this headline">Â¶</a></h2>
<p>We often need to change different environments based on our needs. For instance, normalizing observations is usually very common for different environments so that the training stage is stabler and faster. Therefore, we extract this common part and put this feature in env_wrapper so that repeated developments are avoided and we only need to make a change here instead of every piece of codes if we want to modify the ways of normalistion of observations in the future. The reason that we use running mean and std instead of fixed mean and std is due to the fact that the distribution of samples will be different if different policies are applied, i.e., the distribution of sampled data are highly correlated with a policy.</p>
<p>We show an implementation of ObsNormEnv below in nerveX to explainhow to customize an env wrapper.</p>
</div>
<div class="section" id="to-customize-an-env-wrapper">
<h2>To customize an env wrapper<a class="headerlink" href="#to-customize-an-env-wrapper" title="Permalink to this headline">Â¶</a></h2>
<p>Take the ObsNormEnv wrapper as an example. In order to normalize observations, we merely need to change the two functions in the original environment â the step function and the reset function while keeping the rest functions almost the same. Note that sometimes, info is also needed to be modified as the boundaries of observations have been changed. Note also that the nature of ObsNormEnv wrapper is to add addtional features to the original environment and this is exactly what a wrapper means. </p>
<p>The structure of ObsNormEnv are as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ObsNormEnv</span><span class="p">(</span><span class="n">gym</span><span class="o">.</span><span class="n">ObservationWrapper</span><span class="p">):</span>
     <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Overview:</span>
<span class="sd">     Normalize observations according to running mean and std.</span>
<span class="sd">     Interface:</span>
<span class="sd">         ``__init__``, ``step``, ``reset``, ``observation``, ``new_shape``</span>
<span class="sd">     Properties:</span>
<span class="sd">         - env (:obj:`gym.Env`): the environment to wrap.</span>

<span class="sd">         - ``data_count``, ``clip_range``, ``rms``</span>
<span class="sd">     &quot;&quot;&quot;</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
         <span class="o">...</span>

     <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
         <span class="o">...</span>

     <span class="k">def</span> <span class="nf">observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
         <span class="o">...</span>

     <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
         <span class="o">...</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code>: Initialize <code class="docutils literal notranslate"><span class="pre">episode</span> <span class="pre">count</span></code>, <code class="docutils literal notranslate"><span class="pre">clip_range</span></code>, and <code class="docutils literal notranslate"><span class="pre">running</span> <span class="pre">mean/std</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">step</span></code>: Step the environment with the given action. Repeat action, sum reward,  </p></li>
</ul>
<p>and update <code class="docutils literal notranslate"><span class="pre">count</span> <span class="pre">of</span> <span class="pre">episodes</span></code>, and also update the <code class="docutils literal notranslate"><span class="pre">running</span> <span class="pre">mean</span> <span class="pre">and</span> <span class="pre">std</span></code> property  once after integrating with the input <code class="docutils literal notranslate"><span class="pre">action</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">observation</span></code>: Get obeservations. Return the original one or the normalized one if the <code class="docutils literal notranslate"><span class="pre">count</span> <span class="pre">of</span> <span class="pre">episodes</span></code></p></li>
</ul>
<p>exceeds 30 (default)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reset</span></code>: Resets the state of the environment and reset <code class="docutils literal notranslate"><span class="pre">count</span> <span class="pre">of</span> <span class="pre">episodes</span></code>, <code class="docutils literal notranslate"><span class="pre">running</span> <span class="pre">mean/std</span></code>.</p></li>
</ul>
<p>In general, an env wrapper can be customized as follows:</p>
</div>
<div class="section" id="to-customize-an-general-env-wrapper">
<h2>To customize an general env wrapper<a class="headerlink" href="#to-customize-an-general-env-wrapper" title="Permalink to this headline">Â¶</a></h2>
<p>Users should follow the following steps to customize a model wrapper:</p>
<ol class="arabic simple">
<li><p>Define your env wrapper class like other wrappers in
<code class="docutils literal notranslate"><span class="pre">nervex/envs/env_wrappers/env_wrappers.py</span></code>;</p></li>
<li><p>Wrap your env with <cite>env_wrap</cite> function.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wrapped_env</span> <span class="o">=</span> <span class="n">env_wrap</span><span class="p">(</span><span class="n">origin_env</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="examples">
<h2>Examples: <a class="headerlink" href="#examples" title="Permalink to this headline">Â¶</a></h2>
<p>env = gym.make(evn_id) </p>
<p>env.NoopResetEnv(env, noop_max = 30) </p>
<p>env = MaxAndSkipEnv(env, skip = 4) </p>
<p>More details of env wrappers can be found in
<code class="docutils literal notranslate"><span class="pre">nervex/envs/env_wrappers/env_wrappers.py</span></code></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="registry.html" class="btn btn-neutral float-right" title="Registry" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="model_wrapper.html" class="btn btn-neutral float-left" title="How to Customize Model Wrapper" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, X-Lab.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>