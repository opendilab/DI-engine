

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>How to Customize Model Wrapper &mdash; nerveX 0.2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to Customize an Env Wrapper" href="env_wrapper.html" />
    <link rel="prev" title="Multi-Discrete Example" href="multi_discrete.html" />
    <link href="../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> nerveX
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concept/index.html">Key Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro_rl/index.html">Introduction to RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hands_on/index.html">Hands on RL</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Best Practice</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nstep_td.html">N-step TD</a></li>
<li class="toctree-l2"><a class="reference internal" href="priority.html">How to Use PER(Prioritized Experience Replay)</a></li>
<li class="toctree-l2"><a class="reference internal" href="log.html">Log and Tensorboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="IL.html">Imitation Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="IRL.html">Inverse RL</a></li>
<li class="toctree-l2"><a class="reference internal" href="rnn.html">How to use RNN</a></li>
<li class="toctree-l2"><a class="reference internal" href="random_seed.html">Random seed</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_discrete.html">Multi-Discrete Example</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to Customize Model Wrapper</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#function-of-model-wrapper">Function of Model Wrapper</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="env_wrapper.html">How to Customize an Env Wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="registry.html">Registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="customization1_dynamic_update_step.html">Customization 1: Dynamic Update Step</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_generated_folders.html">How to understand training generated folders?</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_buffer.html">How to use multiple buffers?</a></li>
<li class="toctree-l2"><a class="reference internal" href="random_collect_size.html">How to randomly collect some data sample at the beginning?</a></li>
<li class="toctree-l2"><a class="reference internal" href="irregular_learner_log.html">How to correctly print irregular log?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../feature/index.html">Feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supplementary_rl/index.html">Supplementary of RL</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_dev/index.html">Tutorial-Developer</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">nerveX</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Best Practice</a> &raquo;</li>
        
      <li>How to Customize Model Wrapper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/best_practice/model_wrapper.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-customize-model-wrapper">
<h1>How to Customize Model Wrapper<a class="headerlink" href="#how-to-customize-model-wrapper" title="Permalink to this headline">¶</a></h1>
<div class="section" id="function-of-model-wrapper">
<h2>Function of Model Wrapper<a class="headerlink" href="#function-of-model-wrapper" title="Permalink to this headline">¶</a></h2>
<p>Usually the output of a reinforcement learning model is value, Q or
action logits. Nervex also requires customized model to output part
or all of them. To improve the usability of model and support more
functions, nerveX provides model wrapper to sample action by specific
strategy, adapt to RNN and other functions.</p>
<p>NerveX provides the following model wrapper:</p>
<ul class="simple">
<li><p>BaseModelWrapper. Add reset method for model. In nerveX’s policy implementations,
many policy will call model’s reset method in case of some method may use it
(e.g. HiddenStateWrapper). Wrap each model inherited from <cite>nn.Module</cite> using <cite>model_wrap</cite>
function will be wrapped by BaseModelWrapper automatically.</p></li>
<li><p>HiddenStateWrapper. Add support for models which need to maintain
hidden state like LSTM.</p></li>
<li><p>SampleWrapper, including ArgmaxSampleWrapper,
MultinomialSampleWrapper, EpsGreedySampleWrapper. Allow users to sample
action by argmax, multinomial or epsilon greedy strategy.</p></li>
<li><p>ActionNoiseWrapper. To add noise on output action, mostly used in
continuous action space environment.</p></li>
<li><p>TargetNetworkWrapper. Add a target network for base model, used in DQN
and many other RL algorithms.</p></li>
</ul>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>Users should follow the following steps to customize a model wrapper:</p>
<ol class="arabic simple">
<li><p>Define your model wrapper class like other wrappers in
<code class="docutils literal notranslate"><span class="pre">nervex/model/wrappers/model_wrappers.py</span></code>;</p></li>
<li><p>Add your wrapper’s name into <code class="docutils literal notranslate"><span class="pre">nervex/model/wrappers/model_wrappers.py:</span> <span class="pre">wrapper_name_map</span></code> or use wrapper
register to make sure your wrapper can be retrieved by nervex. In the former
way you can directly use your model wrapper by name without extra registration
or you may need to regist it. Usually the format is like this:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@WRAPPER_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;your_wrapper_name&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">YourWrapper</span><span class="p">(</span><span class="s1">&#39;IModelWrapper&#39;</span><span class="p">):</span>

    <span class="k">pass</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Wrap your model with <cite>model_wrap</cite> function.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wrapped_model</span> <span class="o">=</span> <span class="n">model_wrap</span><span class="p">(</span><span class="n">origin_model</span><span class="p">,</span> <span class="n">wrapper_name</span><span class="o">=</span><span class="s1">&#39;your_wrapper_name&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All model wrappers <strong>must</strong> inherit from <code class="docutils literal notranslate"><span class="pre">IModelWrapper</span></code>.</p>
</div>
<p>We show the implementation of HiddenStateWrapper in nerveX to explain
how to customize a model wrapper.</p>
<p>If we want to use RNN in our model, we’ll have to maintian hidden states
during the training process. With HiddenStateWrapper we can achive this
goal without changing code of policy.</p>
<p>The structure of HiddenStateWrapper are as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HiddenStateWrapper</span><span class="p">(</span><span class="n">IModelWrapper</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
       <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">state_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">save_prev_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">init_fn</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
       <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Overview:</span>

<span class="sd">      Maintain the hidden state for RNN-base model. Each sample in a batch has its own state.</span>
<span class="sd">      Init the maintain state and state function; Then wrap the ``model.foward`` method with auto</span>
<span class="sd">      saved data [&#39;prev_state&#39;] input, and create the ``model.reset`` method.</span>

<span class="sd">    Arguments:</span>

<span class="sd">      - model(:obj:`Any`): Wrapped model class, should contain forward method.</span>
<span class="sd">      - state_num (:obj:`int`): Number of states to process.</span>
<span class="sd">      - save_prev_state (:obj:`bool`): Whether to output the prev state in output[&#39;prev_state&#39;].</span>
<span class="sd">      - init_fn (:obj:`Callable`): The function which is used to init every hidden state when init and reset.</span>
<span class="sd">        Default return None for hidden states.</span>

<span class="sd">    &quot;&quot;&quot;</span>

      <span class="o">...</span>

  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="o">...</span>
      <span class="k">return</span> <span class="n">output</span>

  <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="o">...</span>

  <span class="k">def</span> <span class="nf">reset_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">state_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="o">...</span>

  <span class="k">def</span> <span class="nf">before_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">state_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
      <span class="o">...</span>

  <span class="k">def</span> <span class="nf">after_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">state_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">valid_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
      <span class="o">...</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">__init__</span></code>: Initialize hidden state as arguments, save it as model
property <code class="docutils literal notranslate"><span class="pre">self._state</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">before_forward</span></code>: Put <code class="docutils literal notranslate"><span class="pre">self._state</span></code> into model input data, the key
is ‘prev_state’</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">after_forward</span></code>: Save model’s output <code class="docutils literal notranslate"><span class="pre">next_state</span></code> into
<code class="docutils literal notranslate"><span class="pre">self._state</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reset</span></code>: Reset wrapper related state, e.g. hidden state in RNN</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forward</span></code>: Call <code class="docutils literal notranslate"><span class="pre">before_forward</span></code>, <code class="docutils literal notranslate"><span class="pre">forward</span></code> function of model,
<code class="docutils literal notranslate"><span class="pre">after_forward</span></code> in turn</p></li>
</ul>
<p>The dataflow of this process is as follows:</p>
<blockquote>
<div><a class="reference internal image-reference" href="../_images/model_hiddenwrapper_img.png"><img alt="../_images/model_hiddenwrapper_img.png" class="align-center" src="../_images/model_hiddenwrapper_img.png" style="width: 456.59999999999997px; height: 649.8px;" /></a>
</div></blockquote>
<p>Other examples of model wrapper can be found in
<code class="docutils literal notranslate"><span class="pre">nervex/model/wrappers/model_wrappers.py</span></code>, you can find more details
there.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="env_wrapper.html" class="btn btn-neutral float-right" title="How to Customize an Env Wrapper" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="multi_discrete.html" class="btn btn-neutral float-left" title="Multi-Discrete Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, X-Lab.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>