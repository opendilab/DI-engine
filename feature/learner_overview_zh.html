

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Learner Overview &mdash; DI-engine 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Wrapper &amp; Hook Overview" href="wrapper_hook_overview_zh.html" />
    <link rel="prev" title="Env Manager Overview" href="env_manager_overview_zh.html" />
    <link href="../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index_zh.html" class="icon icon-home"> DI-engine
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">使用者指南</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation/index_zh.html">安装说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index_zh.html">快速上手</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concept/index.html">Key Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro_rl/index_zh.html">强化学习基础概念介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hands_on/index_zh.html">强化学习算法攻略合集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../env_tutorial/index_zh.html">强化学习环境示例手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed/index_zh.html">分布式</a></li>
<li class="toctree-l1"><a class="reference internal" href="../best_practice/index_zh.html">最佳实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index_zh.html">FAQ</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index_zh.html">特性介绍</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="algorithm_overview_zh.html">Algorithm Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="env_overview_zh.html">Env Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="collector_overview_zh.html">Collector Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="env_manager_overview_zh.html">Env Manager Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Learner Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#learner">Learner</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="wrapper_hook_overview_zh.html">Wrapper &amp; Hook Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="hpc_rl_overview_zh.html">HPC_RL Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="interaction_overview_zh.html">Interaction模块介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="autolog_overview_zh.html">Autolog模块介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="loader_overview_zh.html">Loader模块介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataloader_overview_zh.html">DataLoader Overview</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">开发者指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/index_zh.html">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_dev/index.html">Tutorial-Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specification/index_zh.html">中间件（middleware）编写规范</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index_zh.html">DI-engine</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index_zh.html">Docs</a> &raquo;</li>
        
          <li><a href="index_zh.html">特性介绍</a> &raquo;</li>
        
      <li>Learner Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/feature/learner_overview_zh.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="learner-overview">
<h1>Learner Overview<a class="headerlink" href="#learner-overview" title="Permalink to this headline">¶</a></h1>
<div class="section" id="learner">
<h2>Learner<a class="headerlink" href="#learner" title="Permalink to this headline">¶</a></h2>
<dl>
<dt>概述：</dt><dd><p>Learner是RL算法进行训练的核心。在串行与并行两个版本中，learner有着不同的调用接口和运行模式。</p>
</dd>
<dt>代码结构：</dt><dd><p>主要分为如下几个子模块：</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>learner: 可以接收训练数据，进行训练（包括模型更新、策略更新、经验回放池更新等）。</p></li>
<li><p>hook: 用于在训练的特定时间点执行一些函数，如加载模型、保存模型、打印log等</p></li>
<li><p>comm: 用于并行训练中和 coordinator 通信。</p></li>
</ol>
</div></blockquote>
</dd>
<dt>基类定义：</dt><dd><ol class="arabic">
<li><p>BaseLearner (worker/learner/base_learner.py)</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseLearner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overview:</span>
<span class="sd">        Base class for model learning.</span>
<span class="sd">    Interface:</span>
<span class="sd">        __init__, register_hook, train, start, setup_dataloader, close, call_hook, save_checkpoint</span>
<span class="sd">    Property:</span>
<span class="sd">        learn_info, priority_info, last_iter, name, rank, policy</span>
<span class="sd">        tick_time, monitor, log_buffer, logger, tb_logger, load_path</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;BaseLearner&quot;</span>  <span class="c1"># override this variable for sub-class learner</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">EasyDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="o">=</span> <span class="n">deep_merge_dicts</span><span class="p">(</span><span class="n">base_learner_default_config</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_learner_uid</span> <span class="o">=</span> <span class="n">get_task_uid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">load_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_distributed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">use_distributed</span>

        <span class="c1"># Learner rank. Used when there are more than one learner.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">=</span> <span class="n">get_rank</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="s1">&#39;cuda:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cuda</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span>

        <span class="c1"># Logger (Monitor is initialized with policy setter)</span>
        <span class="c1"># Only rank == 0 learner needs monitor and tb_logger, else only needs text_logger to display terminal output.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="n">EasyTimer</span><span class="p">()</span>
        <span class="n">rank0</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tb_logger</span> <span class="o">=</span> <span class="n">build_logger</span><span class="p">(</span><span class="s1">&#39;./log/learner&#39;</span><span class="p">,</span> <span class="s1">&#39;learner&#39;</span><span class="p">,</span> <span class="n">rank0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span> <span class="o">=</span> <span class="n">build_log_buffer</span><span class="p">()</span>

        <span class="c1"># Checkpoint helper. Used to save model checkpoint.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpointer_manager</span> <span class="o">=</span> <span class="n">build_checkpoint_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">)</span>
        <span class="c1"># Learner hook. Used to do specific things at specific time point. Will be set in ``_setup_hook``</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;before_run&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;before_iter&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;after_iter&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;after_run&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="c1"># Priority info. Used to update replay buffer according to data&#39;s priority.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_priority_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Last iteration. Used to record current iter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_iter</span> <span class="o">=</span> <span class="n">CountVar</span><span class="p">(</span><span class="n">init_val</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">pretty_print</span><span class="p">({</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">,</span>
        <span class="p">},</span> <span class="n">direct_print</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Setup wrapper and hook.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_wrapper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_hook</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_hooks&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="n">merge_hooks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">,</span> <span class="n">build_learner_hook_by_cfg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">hook</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span> <span class="o">=</span> <span class="n">build_learner_hook_by_cfg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">hook</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setup_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper_timer</span> <span class="o">=</span> <span class="n">EasyTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="s1">&#39;train_time&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper_timer</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper_timer</span><span class="o">.</span><span class="n">value</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">def</span> <span class="nf">register_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">:</span> <span class="n">LearnerHook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">add_learner_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_policy&#39;</span><span class="p">),</span> <span class="s2">&quot;please set learner policy&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;before_iter&#39;</span><span class="p">)</span>
        <span class="c1"># Pre-process data</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">data_preprocess</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Forward</span>
        <span class="n">log_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Update replay buffer&#39;s priority info</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="n">log_vars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">replay_buffer_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;replay_buffer_idx&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">replay_unique_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;replay_unique_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_priority_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;replay_buffer_idx&#39;</span><span class="p">:</span> <span class="n">replay_buffer_idx</span><span class="p">,</span>
            <span class="s1">&#39;replay_unique_id&#39;</span><span class="p">:</span> <span class="n">replay_unique_id</span><span class="p">,</span>
            <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">priority</span>
        <span class="p">}</span>
        <span class="c1"># Update log_buffer</span>
        <span class="n">log_vars</span><span class="p">[</span><span class="s1">&#39;data_preprocess_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_buffer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">log_vars</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;after_iter&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_iter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@auto_checkpoint</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># before run hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;before_run&#39;</span><span class="p">)</span>

        <span class="n">max_iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">max_iterations</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_finished_task</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;finish&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="c1"># after run hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_hook</span><span class="p">(</span><span class="s1">&#39;after_run&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">dataloader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span> <span class="o">=</span> <span class="n">AsyncDataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">num_workers</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span><span class="p">,</span> <span class="s1">&#39;data_time&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_next_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_dataloader&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataloader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tb_logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">call_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">hook</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="s1">&#39;after_run&#39;</span><span class="p">]]</span>
        <span class="k">assert</span> <span class="s1">&#39;save_ckpt_after_run&#39;</span> <span class="ow">in</span> <span class="n">names</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;save_ckpt_after_run&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hooks</span><span class="p">[</span><span class="s1">&#39;after_run&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<ul>
<li><dl class="simple">
<dt>概述：</dt><dd><p>learner基类，是串行模式与并行模式中进行训练的核心。</p>
</dd>
</dl>
</li>
<li><dl>
<dt>接口方法：</dt><dd><ol class="arabic simple">
<li><p>__init__: 初始化</p></li>
<li><p>train: 传入训练数据，训练一个迭代，可被串行pipeline或 <code class="docutils literal notranslate"><span class="pre">start</span></code> 调用。</p></li>
<li><p>start: 训练多个迭代，每个迭代中自行发送获取数据的请求，拿到数据后调用 <code class="docutils literal notranslate"><span class="pre">train</span></code> 进行训练，可被并行pipeline调用。</p></li>
<li><p>setup_dataloader: 为并行训练设置dataloader。</p></li>
<li><p>close: 正确关闭各项资源。</p></li>
<li><p>call_hook: 根据传入的hook位置名，调用该位置所有hook。</p></li>
<li><p>register_hook: 注册新的hook。</p></li>
<li><p>save_checkpoint: 调用hook保存checkpoint。</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>在 <strong>串行pipeline</strong> 中，learner与collector交替工作（同步），故 <code class="docutils literal notranslate"><span class="pre">train</span></code> 方法是从外界传入训练数据，由learner训练一个迭代。</p>
<p>而在 <strong>并行pipeline</strong> 中，learner与collector同一时刻都在工作（异步），故 <code class="docutils literal notranslate"><span class="pre">start</span></code> 方法可作为一个线程启动，自行从dataloader获取数据（所以dataloader是并行pipeline特有的，串行没有），根据预先设定的最大迭代数及evaluate收敛情况，训练多个迭代。其中每一个迭代在获取数据后，都调用 <code class="docutils literal notranslate"><span class="pre">train</span></code> 进行当前迭代的训练。</p>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</li>
<li><p>Hook 与 LearnerHook (worker/learner/learner_hook.py)</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Hook</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">priority</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;invalid priority value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">priority</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span> <span class="o">=</span> <span class="n">priority</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">LearnerHook</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;before_run&#39;</span><span class="p">,</span> <span class="s1">&#39;after_run&#39;</span><span class="p">,</span> <span class="s1">&#39;before_iter&#39;</span><span class="p">,</span> <span class="s1">&#39;after_iter&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">position</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">position</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">position</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span>
</pre></div>
</div>
<ul class="simple">
<li><dl class="simple">
<dt>概述：</dt><dd><p>Hook是最基本的基类，仅定义名字name和优先度priority。
LearnerHook是在其基础上针对learner的封装，考虑到learner可能需要在整个训练前后，及每一个迭代前后执行一些函数，而添加了位置position这一属性，该属性取值必须为类变量positions中的一个。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>类接口方法：</dt><dd><ol class="arabic simple">
<li><p>__init__: 初始化。</p></li>
<li><p>__call__: 调用hook要执行的函数。（子类必须重写实现该方法）</p></li>
</ol>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</li>
<li><p>BaseCommLearner (worker/learner/comm/base_comm_learner.py)</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseCommLearner</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="s1">&#39;EasyDict&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_learner_uid</span> <span class="o">=</span> <span class="n">get_task_uid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="n">EasyTimer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_distributed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_world_size</span> <span class="o">=</span> <span class="n">dist_init</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_world_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_distributed</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_distributed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_flag</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">send_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">send_learn_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_distributed</span><span class="p">:</span>
            <span class="n">dist_finalize</span><span class="p">()</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">hooks4call</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">_create_learner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseLearner</span><span class="p">:</span>
        <span class="c1"># Prepare learner config and instantiate a learner object.</span>
        <span class="n">learner_cfg</span> <span class="o">=</span> <span class="n">EasyDict</span><span class="p">(</span><span class="n">task_info</span><span class="p">[</span><span class="s1">&#39;learner_cfg&#39;</span><span class="p">])</span>
        <span class="n">learner_cfg</span><span class="p">[</span><span class="s1">&#39;use_distributed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_distributed</span>
        <span class="n">learner</span> <span class="o">=</span> <span class="n">BaseLearner</span><span class="p">(</span><span class="n">learner_cfg</span><span class="p">)</span>
        <span class="c1"># Set 3 methods and dataloader in created learner that are necessary in parallel setting.</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;get_data&#39;</span><span class="p">,</span> <span class="s1">&#39;send_policy&#39;</span><span class="p">,</span> <span class="s1">&#39;send_learn_info&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">learner</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">setup_dataloader</span><span class="p">()</span>
        <span class="c1"># Set policy in created learner.</span>
        <span class="n">policy_cfg</span> <span class="o">=</span> <span class="n">task_info</span><span class="p">[</span><span class="s1">&#39;policy&#39;</span><span class="p">]</span>
        <span class="n">policy_cfg</span><span class="p">[</span><span class="s1">&#39;use_distributed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_distributed</span>
        <span class="n">learner</span><span class="o">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">create_policy</span><span class="p">(</span><span class="n">policy_cfg</span><span class="p">,</span> <span class="n">enable_field</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;learn&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">learn_mode</span>
        <span class="k">return</span> <span class="n">learner</span>
</pre></div>
</div>
<ul>
<li><dl>
<dt>概述：</dt><dd><p>base learner可以独立完成串行pipeline中的训练工作，但对于并行pipeline来说，虽然提供了训练接口，但还有一些问题尚未解决，如数据怎么获得，如何与外界通信等等，comm learner便是负责解决并行模式中的这些问题的。</p>
<p>comm learner并不实际进行训练，其持有一个base learner，并为其解决涉及通信的问题，依然由base learner进行训练。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>故串行pipeline可以实例化base learner并直接对其操作；但在并行pipeline中应当实例化comm learner，再由comm learner通过 <code class="docutils literal notranslate"><span class="pre">_create_learner</span></code> 创建base learner。</p>
</div>
<p>在并行训练模式中，learner需要自己发出数据请求、定时将当前策略及训练信息发送出去，这些操作将以hook的方式完成，而comm learner的一个重要工作就是将这些hook及执行hook时所需要的函数注册至learner中，即在 <code class="docutils literal notranslate"><span class="pre">hooks4call</span></code> 中返回上述hook，并实现 <code class="docutils literal notranslate"><span class="pre">get_data</span></code> , <code class="docutils literal notranslate"><span class="pre">send_policy</span></code> ,  <code class="docutils literal notranslate"><span class="pre">send_learn_info</span></code> 三个方法hook中需要用到的方法。</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>类变量：</dt><dd><p>无</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>类接口方法：</dt><dd><ol class="arabic simple">
<li><p>__init__：初始化</p></li>
<li><p>start：开启comm learner服务</p></li>
<li><p>close：关闭comm learner服务</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>子类需继承重写方法：</dt><dd><ol class="arabic simple">
<li><p>get_data: 获取数据的函数，AyncDataLoader的参数</p></li>
<li><p>send_policy: 将策略存储或发送</p></li>
<li><p>send_learn_info: 将训练信息存储或发送</p></li>
<li><p>hooks4call: 策略与训练信息的定时存储或发送的hooks dict</p></li>
</ol>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</li>
</ol>
</dd>
<dt>并行模式中的训练流程解析：</dt><dd><p>相对于简单直接的串行模式，并行模式由于涉及到异步运行的learner collector之间的通信问题，更加晦涩难懂。故在这一部分以我们实现的 <strong>FlaskFileSystemLearner(worker/learner/comm/flask_fs_learner.py)</strong> ——这一使用flask及文件系统进行通信的comm learner——为例，来介绍并行模式中从并行pipeline入口部署coordinator, comm learner开始，到二者建立通信连接，再到coordinator启动comm learner并为其一次或多次分配任务，到最终二者关闭通信连接的流程。</p>
<blockquote>
<div><img alt="../_images/parallel_learner_sequence.jpg" src="../_images/parallel_learner_sequence.jpg" />
<p>上图即展示了coordinator和comm learner从被并行pipeline部署，到建立连接，到实际任务分配与执行，再到最后断开连接的过程。至于实际任务的分配与执行，请继续阅读。</p>
</div></blockquote>
<p>在介绍FlaskFileSystemLearner前，还有必要介绍一下LearnerSlave，这一真正负责和coordinator进行通信的类。LearnerSlave继承自Slave，其master为coordinator中的变量master，负责和coordinator通信，处理master发来的task，并利用FlaskFileSystemLearner传来的回调函数响应相应的task。其本质是利用master-slave机制帮助FlaskFileSystemLearner完成与coordinator的通信工作。</p>
<p>BaseCommLearner, FlaskFileSystemLearner, BaseLearner, LearnerSlave这几个类之间的关系可见类图所示(本类图并不完整，仅包含为理解后述工作流程所必须的部分)：</p>
<blockquote>
<div><img alt="../_images/comm_learner_class.jpg" src="../_images/comm_learner_class.jpg" />
</div></blockquote>
<p>然后我们开始介绍并行模式下的FlaskFileSystemLearner这一comm learner的工作流程，即实际任务的分配与执行过程，也即第一张顺序图中被略去的部分。可以参考以下顺序图帮助理解。</p>
<blockquote>
<div><img alt="../_images/comm_learner_sequence.jpg" src="../_images/comm_learner_sequence.jpg" />
</div></blockquote>
<ol class="arabic">
<li><dl>
<dt>comm learner的创建</dt><dd><p>并行pipeline会创建comm learner，并调用 <code class="docutils literal notranslate"><span class="pre">start</span></code> 方法以启动comm learner服务</p>
<p>comm learner中先是实例化一个 <strong>learner slave</strong> ，将自己的四个函数作为回调函数传给learner slave（至于什么是回调函数及回调函数是用来做什么的，我们在后边的流程中再解释），learner slave会通过预先商定的ip地址与端口号与coordinator建立连接。</p>
<p>此外，comm learner创建几个 <strong>长度为1的队列</strong> ，用于存放一些和通信相关的消息字典。</p>
</dd>
</dl>
</li>
<li><dl>
<dt>learner的创建</dt><dd><p>在coordinator发来任务之前，comm learner及learner slave一直都处于待命状态。一旦coordinator发来任务，learner slave的 <code class="docutils literal notranslate"><span class="pre">_process_task</span></code> 就会接收到该任务。</p>
<p>coordinator知道comm learner的工作流程为： <strong>首先建立learner，然后重复执行获取数据、利用数据训练这一过程，直到训练结束</strong> 。故此时的任务应当为 <code class="docutils literal notranslate"><span class="pre">learner_start_task</span></code> ，此外还传来建立learner必须的信息。</p>
<p>这些信息都传到了learner slave处，但learner的创建是在comm learner中完成的，这就用到了我们刚刚提到的 <strong>回调函数</strong> 。回调函数由comm learner实现，但作为参数传递给learner slave，故learner slave可以调用这些函数。</p>
<p>对于 <code class="docutils literal notranslate"><span class="pre">learner_start_task</span></code> ，learner slave调用comm learner的 <code class="docutils literal notranslate"><span class="pre">deal_with_learner_start</span></code> 方法，完成建立learner的工作。完成后，learner slave向coordinator返回成功的信息。</p>
</dd>
</dl>
</li>
<li><dl>
<dt>learner get data</dt><dd><p>learner在建立后，dataloader便会调用comm learner中实现的 <code class="docutils literal notranslate"><span class="pre">get_data</span></code> 方法 <strong>试图获取数据</strong> ， <code class="docutils literal notranslate"><span class="pre">get_data</span></code> 中会在comm learner的 <code class="docutils literal notranslate"><span class="pre">_data_demand_queue</span></code> 放入这一数据请求，然后试图从 <code class="docutils literal notranslate"><span class="pre">_data_result_queue</span></code> 中取出数据，若其为空，就被 <strong>阻塞</strong> 在了这里。</p>
<p>视线回到coordinator，当coordinator收到流程2中最后 <code class="docutils literal notranslate"><span class="pre">learner_start_task</span></code> 成功执行的信息后，发送任务 <code class="docutils literal notranslate"><span class="pre">learner_get_data_task</span></code> ，learner slave调用comm learner中的 <code class="docutils literal notranslate"><span class="pre">deal_with_get_data</span></code> ，从 <code class="docutils literal notranslate"><span class="pre">_data_demand_queue</span></code> 中取出数据请求，并返回给coordinator。</p>
</dd>
</dl>
</li>
<li><dl>
<dt>learner learn</dt><dd><p>coordinator在收到learner的数据请求后，会发送 <code class="docutils literal notranslate"><span class="pre">learner_learn_task</span></code> 给learner slave，其中就包含了learner请求的 <strong>数据</strong> （或元数据） 。learner slave收到后调用comm learner的 <code class="docutils literal notranslate"><span class="pre">deal_with_learner_learn</span></code> 方法，将收到的数据信息放入 <code class="docutils literal notranslate"><span class="pre">_data_result_queue</span></code> 中，并等待learner结束训练，可以从 <code class="docutils literal notranslate"><span class="pre">_learn_info_queue</span></code> 中获取训练信息。</p>
<p>视线回到learner，learner是因为dataloader无法获得数据而被阻塞住的，现在 <code class="docutils literal notranslate"><span class="pre">_data_result_queue</span></code> 中有了数据信息，dataloader可以将其取出，处理成learner需要的格式，交由learner <strong>训练一个迭代</strong> 。训练完成后，learner将训练信息存放在 <code class="docutils literal notranslate"><span class="pre">_learn_info_queue</span></code> 当中。</p>
<p>视线回到comm learner的 <code class="docutils literal notranslate"><span class="pre">deal_with_learner_learn</span></code> 方法，它从 <code class="docutils literal notranslate"><span class="pre">_learn_info_queue</span></code> 取出训练信息，并将其通过learner slave返回给coordinator。对于该信息的内容有 <strong>两种情况</strong> ：</p>
<blockquote>
<div><ul class="simple">
<li><p>learner没有完成训练，需要继续迭代：此时dataloader又会调用 <code class="docutils literal notranslate"><span class="pre">get_data</span></code> ，coordinator也会在收到该信息后继续发送任务 <code class="docutils literal notranslate"><span class="pre">learner_get_data_task</span></code> ，便回到了流程3。</p></li>
<li><p>learner完成训练：comm learner中会将learner关闭，等待coordinator再次分配新的任务 <code class="docutils literal notranslate"><span class="pre">learner_start_task</span></code> ，完成新的训练工作，便回到了流程2。</p></li>
</ul>
</div></blockquote>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>comm learner close</dt><dd><p>可以通过输入命令的方式手动关闭comm learner；否则comm learner将 <strong>常驻</strong> ，等待coordinator分配新的任务，执行后返回结果。</p>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="wrapper_hook_overview_zh.html" class="btn btn-neutral float-right" title="Wrapper &amp; Hook Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="env_manager_overview_zh.html" class="btn btn-neutral float-left" title="Env Manager Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, OpenDILab Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>