

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to use multiple buffers? &mdash; DI-engine 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Registry" href="registry.html" />
    <link rel="prev" title="How to use Episode Replay Buffer?" href="episode_buffer.html" />
    <link href="../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> DI-engine
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concept/index.html">Key Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro_rl/index.html">Introduction to RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hands_on/index.html">RL Algorithm Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../env_tutorial/index.html">RL Environments Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed/index.html">Distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../feature/index.html">Feature</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_dev/index.html">Tutorial-Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specification/index.html">Middleware code specification</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DI-engine</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Best Practice</a> &raquo;</li>
        
      <li>How to use multiple buffers?</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/best_practice/multi_buffer.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-use-multiple-buffers">
<h1>How to use multiple buffers?<a class="headerlink" href="#how-to-use-multiple-buffers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="guideline">
<h2>Guideline<a class="headerlink" href="#guideline" title="Permalink to this headline">¶</a></h2>
<p>In some algorithms, it is required to use multiple buffers. For example, in <a class="reference external" href="https://arxiv.org/pdf/1909.01387.pdf">R2D3</a>, there is a demonstration buffer full of expert data and an agent buffer collected during training; In <a class="reference external" href="https://arxiv.org/pdf/2009.04416.pdf">Phasic Policy Gradient</a>, there is a value buffer and a policy buffer respectively designed for critic optimization and actor optimization.</p>
<p>However, DI-engine <cite>serial_pipeline</cite> only supports single buffer. So in this section, we will teach you how to write the configuration file and your own multi-buffer pipeline. We will take <cite>PPG</cite> algorithm as an example.</p>
</div>
<div class="section" id="config">
<h2>1. Config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>We show core part of <cite>ding/dizoo/classic_control/cartpole/config/cartpole_ppg_config.py</cite> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cartpole_ppg_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="n">policy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="c1"># ...</span>
        <span class="n">other</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">replay_buffer</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">multi_buffer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">policy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">replay_buffer_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="c1"># DI-engine implemented PPG is not the same as original paper version.</span>
                    <span class="c1"># In DI-engine, we utilize `max_use` to control how many times data is used to optimize</span>
                    <span class="c1"># actor and critic network.</span>
                    <span class="n">max_use</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">replay_buffer_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                    <span class="n">max_use</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You must set <code class="docutils literal notranslate"><span class="pre">multi_buffer</span></code> to True; Then list all buffers’ configuration.</p>
<p>If you want to use <cite>create_cfg</cite>, you must list all buffers’ type:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cartpole_ppg_create_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="n">replay_buffer</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">policy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;priority&#39;</span><span class="p">),</span>
        <span class="n">value</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;priority&#39;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="pipeline">
<h2>2. Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>After finishing the config file, you can write your own pipeline. Here is an example from <cite>dizoo/classic_control/cartpole/entry/cartpole_ppg_main.py</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Init two buffers</span>
<span class="n">policy_buffer</span> <span class="o">=</span> <span class="n">AdvancedReplayBuffer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">policy</span><span class="p">,</span> <span class="n">tb_logger</span><span class="p">,</span> <span class="s1">&#39;policy&#39;</span><span class="p">)</span>
<span class="n">value_buffer</span> <span class="o">=</span> <span class="n">AdvancedReplayBuffer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">replay_buffer</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">tb_logger</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># ...</span>
    <span class="n">new_data</span> <span class="o">=</span> <span class="n">collector</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">train_iter</span><span class="o">=</span><span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">)</span>
    <span class="c1"># Push data into two buffers respectively. If you may change data in buffer, you can deepcopy it.</span>
    <span class="n">policy_buffer</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">cur_collector_envstep</span><span class="o">=</span><span class="n">collector</span><span class="o">.</span><span class="n">envstep</span><span class="p">)</span>
    <span class="n">value_buffer</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">cur_collector_envstep</span><span class="o">=</span><span class="n">collector</span><span class="o">.</span><span class="n">envstep</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">update_per_collect</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">learner</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">)</span>
        <span class="c1"># Sample from two buffers respectively. Form the new `train_data` and start learner training.</span>
        <span class="n">policy_data</span> <span class="o">=</span> <span class="n">policy_buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">batch_size</span><span class="p">[</span><span class="s1">&#39;policy&#39;</span><span class="p">],</span> <span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">)</span>
        <span class="n">value_data</span> <span class="o">=</span> <span class="n">policy_buffer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">batch_size</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">learner</span><span class="o">.</span><span class="n">train_iter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">policy_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;policy&#39;</span><span class="p">:</span> <span class="n">policy_data</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value_data</span><span class="p">}</span>
            <span class="n">learner</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">collector</span><span class="o">.</span><span class="n">envstep</span><span class="p">)</span>
</pre></div>
</div>
<p>There are two issues you should pay attention to:</p>
<blockquote>
<div><ul class="simple">
<li><p>Rewrite policy’s <code class="docutils literal notranslate"><span class="pre">_get_batch_size</span></code> method. Its return should be a dict like <code class="docutils literal notranslate"><span class="pre">{'value':</span> <span class="pre">32,</span> <span class="pre">'policy':</span> <span class="pre">32}</span></code>.</p></li>
<li><p>(Optional) Rewrite policy’s <code class="docutils literal notranslate"><span class="pre">_process_transition</span></code> method. Specify each data which buffer it should be pushed into. In this example, same data are pushed into to two buffers respectively. But you can also push value data into value buffer, and policy data into policy buffer.</p></li>
</ul>
</div></blockquote>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="registry.html" class="btn btn-neutral float-right" title="Registry" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="episode_buffer.html" class="btn btn-neutral float-left" title="How to use Episode Replay Buffer?" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, OpenDILab Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>