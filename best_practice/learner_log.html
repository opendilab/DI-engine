

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Learner log &mdash; DI-engine 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to Customize Model Wrapper" href="model_wrapper.html" />
    <link rel="prev" title="How to understand training generated folders?" href="training_generated_folders.html" />
    <link href="../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> DI-engine
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../key_concept/index.html">Key Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro_rl/index.html">Introduction to RL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hands_on/index.html">RL Algorithm Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../env_tutorial/index.html">RL Environments Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../distributed/index.html">Distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc/index.html">API Doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../feature/index.html">Feature</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial_dev/index.html">Tutorial-Developer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/index.html">Architecture Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specification/index.html">Middleware code specification</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DI-engine</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Best Practice</a> &raquo;</li>
        
      <li>Learner log</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/best_practice/learner_log.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="learner-log">
<h1>Learner log<a class="headerlink" href="#learner-log" title="Permalink to this headline">¶</a></h1>
<div class="section" id="basic-guidance">
<h2>Basic Guidance<a class="headerlink" href="#basic-guidance" title="Permalink to this headline">¶</a></h2>
<p>If you want to print variables in learner logger. You should concentrate on two components:</p>
<blockquote>
<div><ul class="simple">
<li><p>Learn Mode Policy</p></li>
<li><p>Learner</p></li>
</ul>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">Policy</span></code> abstract base class supports two default variables <code class="docutils literal notranslate"><span class="pre">['cur_lr',</span> <span class="pre">'total_loss']</span></code> (in <code class="docutils literal notranslate"><span class="pre">_monitor_vars_learn</span></code> method). If the policy needs to print more variables, you should change two places:</p>
<blockquote>
<div><ol class="arabic">
<li><p>Additionally add <strong>variables’ names</strong> in  <code class="docutils literal notranslate"><span class="pre">xxxPolicy</span></code>’s <code class="docutils literal notranslate"><span class="pre">_monitor_vars_learn</span></code> method. Let’s take PPO as an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_monitor_vars_learn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
   <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_monitor_vars_learn</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span>
         <span class="s1">&#39;policy_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;value_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;entropy_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;adv_abs_max&#39;</span><span class="p">,</span> <span class="s1">&#39;approx_kl&#39;</span><span class="p">,</span> <span class="s1">&#39;clipfrac&#39;</span>
   <span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>In <code class="docutils literal notranslate"><span class="pre">Policy</span></code>’s <code class="docutils literal notranslate"><span class="pre">_forward_learn</span></code> method，return <strong>key-value</strong> pair in dict type (<code class="docutils literal notranslate"><span class="pre">{'var-name':</span> <span class="pre">'var-value'}</span></code>). Also takes PPO as an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_forward_learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>

   <span class="c1"># ...</span>
   <span class="c1"># ====================</span>
   <span class="c1"># PPO update</span>
   <span class="c1"># ====================</span>
   <span class="c1"># ...</span>
   <span class="k">return</span> <span class="p">{</span>
         <span class="s1">&#39;cur_lr&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span><span class="o">.</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span>
         <span class="s1">&#39;total_loss&#39;</span><span class="p">:</span> <span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
         <span class="s1">&#39;policy_loss&#39;</span><span class="p">:</span> <span class="n">ppo_loss</span><span class="o">.</span><span class="n">policy_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
         <span class="s1">&#39;value_loss&#39;</span><span class="p">:</span> <span class="n">ppo_loss</span><span class="o">.</span><span class="n">value_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
         <span class="s1">&#39;entropy_loss&#39;</span><span class="p">:</span> <span class="n">ppo_loss</span><span class="o">.</span><span class="n">entropy_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
         <span class="s1">&#39;adv_abs_max&#39;</span><span class="p">:</span> <span class="n">adv</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
         <span class="s1">&#39;approx_kl&#39;</span><span class="p">:</span> <span class="n">ppo_info</span><span class="o">.</span><span class="n">approx_kl</span><span class="p">,</span>
         <span class="s1">&#39;clipfrac&#39;</span><span class="p">:</span> <span class="n">ppo_info</span><span class="o">.</span><span class="n">clipfrac</span><span class="p">,</span>
   <span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DI-engine uses <code class="docutils literal notranslate"><span class="pre">LoggedModel</span></code> to track and monitor all variables returned by the policy. <code class="docutils literal notranslate"><span class="pre">LoggedModel</span></code> saves variables in a sliding window to keep monitoring, and some statistics that you request, for instance, min, max, mean, etc. are calculated. If you are interested, you can refer to <a class="reference external" href="../feature/autolog_overview.html">autolog</a> for more details. Or you can also skip to the bottom and see <strong>Developer view</strong>.</p>
<p>Among all the statistics, <strong>mean</strong> is the commonest and the most important one. As a reulst, DI-engine calculated all scalar type variables’ mean, and print them in text logger &amp; tensorboard logger.</p>
</div>
</div>
<div class="section" id="advanced-guidance">
<h2>Advanced Guidance<a class="headerlink" href="#advanced-guidance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="irregular-log">
<h3>1. Irregular Log<a class="headerlink" href="#irregular-log" title="Permalink to this headline">¶</a></h3>
<p>Each policy’s <code class="docutils literal notranslate"><span class="pre">_forward_learn</span></code> method will return some related dict type info to learner every iteration, then learner will print the info afterwards.</p>
<p>However, the return info dict does not always have the same keys: <a class="reference external" href="https://arxiv.org/pdf/2009.04416.pdf">Phasic Policy Gradient</a>’s auxiliary loss and <a class="reference external" href="https://arxiv.org/pdf/1802.09477.pdf">TD3</a>’s actor loss will be calculated at some intervals. For example, in <cite>PPG</cite>, auxiliary losses will be calculated every ten iterations. So in continuous ten iteration, nine will only have basic info, and the left one will have extra auxiliary loss info.</p>
<p>In DI-engine, it is permitted to only return some keys in some iterations’ info dict. And you can print them just as basic info. You can refer to <a class="reference external" href="./log.html">log</a> for more details.</p>
<p>But you must make sure that, in policy’s method <code class="docutils literal notranslate"><span class="pre">_monitor_vars_learn</span></code>, you must list <strong>all</strong> keys that may appear in info dict, no matter they appear every iteration or appear periodically. Then learner can utilize sliding window average to print variable’s correct value.</p>
<p>Here is an example from PPG.</p>
<p>Auxiliary losses be calculated every <cite>self._cfg.learn.aux_freq</cite> iterations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_forward_learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_iteration</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">aux_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">aux_loss</span><span class="p">,</span> <span class="n">bc_loss</span><span class="p">,</span> <span class="n">aux_value_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_aux</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># ...</span>
            <span class="s1">&#39;aux_value_loss&#39;</span><span class="p">:</span> <span class="n">aux_value_loss</span><span class="p">,</span>
            <span class="s1">&#39;auxiliary_loss&#39;</span><span class="p">:</span> <span class="n">aux_loss</span><span class="p">,</span>
            <span class="s1">&#39;behavioral_cloning_loss&#39;</span><span class="p">:</span> <span class="n">bc_loss</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="c1"># ...</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>You should list those three losses’ names in method <code class="docutils literal notranslate"><span class="pre">_monitor_vars_learn</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_monitor_vars_learn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="c1"># ...</span>
        <span class="s1">&#39;aux_value_loss&#39;</span><span class="p">,</span>
        <span class="s1">&#39;auxiliary_loss&#39;</span><span class="p">,</span>
        <span class="s1">&#39;behavioral_cloning_loss&#39;</span><span class="p">,</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>Here is a tensorboard example:</p>
<img alt="../_images/irregular_learner_log.png" src="../_images/irregular_learner_log.png" />
<p><code class="docutils literal notranslate"><span class="pre">approx_kl</span></code> is a basic info that appears in every iteration; <code class="docutils literal notranslate"><span class="pre">aux_value_loss</span></code> and <code class="docutils literal notranslate"><span class="pre">auxiliary_loss</span></code> is a periodic info, its frequency is 10 iterations.
In DI-engine learner, every variable is averaged in a sliding window, so we can notice that in tensorboard, these three variables are <code class="docutils literal notranslate"><span class="pre">approx_kl_avg</span></code>, <code class="docutils literal notranslate"><span class="pre">aux_value_loss_avg</span></code> and <code class="docutils literal notranslate"><span class="pre">auxiliary_loss_avg</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The sliding window has a fixed length, for example, 20 iterations. Basic variable like <code class="docutils literal notranslate"><span class="pre">approx_kl_avg</span></code> is averaged over 20 values, while periodic variable like <code class="docutils literal notranslate"><span class="pre">aux_value_loss_avg</span></code> is averaged over only 2 values.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Since <code class="docutils literal notranslate"><span class="pre">aux_value_loss</span></code> is calculated every 10 iterations. You should make sure that your sliding window size is larger than 10; Otherwise <code class="docutils literal notranslate"><span class="pre">aux_value_loss</span></code> might be calculated incorrectly.</p>
</div>
</div>
<div class="section" id="other-types-of-variables-besides-scalar-e-g-histogram">
<h3>2. Other Types of Variables Besides <cite>Scalar</cite> (e.g. <cite>Histogram</cite>)<a class="headerlink" href="#other-types-of-variables-besides-scalar-e-g-histogram" title="Permalink to this headline">¶</a></h3>
<p>For all variables that need to be printed in tensorboard logger, we assume them scalar type by default. If you want to print other types of variables, you need to specify in <code class="docutils literal notranslate"><span class="pre">Policy</span></code> ‘s <code class="docutils literal notranslate"><span class="pre">_forward_learn</span></code> method.</p>
<p>For example, for discrete action, you want to know action’s distribution in a batch. You can change as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in class `xxPolicy`</span>
<span class="k">def</span> <span class="nf">_forward_learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>

   <span class="c1"># ...</span>
   <span class="c1"># =============</span>
   <span class="c1"># after update</span>
   <span class="c1"># =============</span>
   <span class="c1"># ...</span>
   <span class="k">return</span> <span class="p">{</span>
         <span class="c1"># ...</span>
         <span class="s1">&#39;[histogram]action_distribution&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">],</span>
   <span class="p">}</span>
</pre></div>
</div>
<p>In the returned dict, the key should be named like <code class="docutils literal notranslate"><span class="pre">'[VAR-TYPE]VAR-NAME'</span></code>, i.e. Use <code class="docutils literal notranslate"><span class="pre">'[]'</span></code> to denote the variable type.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since learner uses <code class="docutils literal notranslate"><span class="pre">&quot;[]&quot;</span></code> to split variable type and its name. As a result, <strong>do not use ]</strong> in var name!</p>
</div>
<p>The tensorboard log will be like:</p>
<a class="reference internal image-reference" href="../_images/histogram_log.png"><img alt="../_images/histogram_log.png" class="align-center" src="../_images/histogram_log.png" style="width: 503.99999999999994px; height: 391.29999999999995px;" /></a>
</div>
<div class="section" id="design-statistics-in-loggedmodel">
<h3>3. Design Statistics In <code class="docutils literal notranslate"><span class="pre">LoggedModel</span></code><a class="headerlink" href="#design-statistics-in-loggedmodel" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>By default, <code class="docutils literal notranslate"><span class="pre">LoggedModel</span></code> will calculate scalar type variables’ mean value. If you need other types of statistics, you can refer to <code class="docutils literal notranslate"><span class="pre">SampledDataAttrMonitor</span></code> in <a class="reference external" href="../api_doc/data/structure.html#buffer">buffer</a>, and change <code class="docutils literal notranslate"><span class="pre">TickMonitor</span></code> in <a class="reference external" href="../api_doc/worker/learner/learner.html#base-learner">base learner</a>. You should pay attention to functions like <code class="docutils literal notranslate"><span class="pre">__max_func</span></code> implemented in <code class="docutils literal notranslate"><span class="pre">__register</span></code> method. Also, remember to register a property(e.g. <code class="docutils literal notranslate"><span class="pre">max</span></code> <code class="docutils literal notranslate"><span class="pre">min</span></code>) of an attribute(e.g. <code class="docutils literal notranslate"><span class="pre">priority</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SampledDataAttrMonitor</span><span class="p">(</span><span class="n">LoggedModel</span><span class="p">):</span>

   <span class="n">use_max</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
   <span class="n">use_avg</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
   <span class="n">priority_max</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
   <span class="n">priority_avg</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
   <span class="n">priority_min</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
   <span class="n">staleness_max</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
   <span class="n">staleness_avg</span> <span class="o">=</span> <span class="n">LoggedValue</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_</span><span class="p">:</span> <span class="s1">&#39;BaseTime&#39;</span><span class="p">,</span> <span class="n">expire</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>  <span class="c1"># noqa</span>
      <span class="n">LoggedModel</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_</span><span class="p">,</span> <span class="n">expire</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__register</span><span class="p">()</span>

   <span class="k">def</span> <span class="nf">__register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

      <span class="k">def</span> <span class="nf">__avg_func</span><span class="p">(</span><span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_values</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]()</span>
            <span class="n">_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_value</span> <span class="k">for</span> <span class="p">(</span><span class="n">_begin_time</span><span class="p">,</span> <span class="n">_end_time</span><span class="p">),</span> <span class="n">_value</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

      <span class="k">def</span> <span class="nf">__max_func</span><span class="p">(</span><span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_values</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]()</span>
            <span class="n">_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_value</span> <span class="k">for</span> <span class="p">(</span><span class="n">_begin_time</span><span class="p">,</span> <span class="n">_end_time</span><span class="p">),</span> <span class="n">_value</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

      <span class="k">def</span> <span class="nf">__min_func</span><span class="p">(</span><span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_values</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]()</span>
            <span class="n">_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_value</span> <span class="k">for</span> <span class="p">(</span><span class="n">_begin_time</span><span class="p">,</span> <span class="n">_end_time</span><span class="p">),</span> <span class="n">_value</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__avg_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="s1">&#39;use_avg&#39;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__max_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="s1">&#39;use_max&#39;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__avg_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="s1">&#39;priority_avg&#39;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__max_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="s1">&#39;priority_max&#39;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__min_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="s1">&#39;priority_min&#39;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;staleness&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__avg_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="s1">&#39;staleness_avg&#39;</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">register_attribute_value</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;staleness&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">__max_func</span><span class="p">,</span> <span class="n">prop_name</span><span class="o">=</span><span class="s1">&#39;staleness_max&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="how-does-di-engine-record-and-print-variables-in-learner-log-developer-view">
<h2>How Does DI-engine Record And Print variables In Learner Log? (Developer View)<a class="headerlink" href="#how-does-di-engine-record-and-print-variables-in-learner-log-developer-view" title="Permalink to this headline">¶</a></h2>
<p>In this section, we will introduce how DI-engine record variables to the sliding window, and how DI-engine print averaged variables to logger.
You can skip it if not interested.</p>
<p>In DI-engine, learner get info dict from policy’s <code class="docutils literal notranslate"><span class="pre">_forward_learn</span></code> method. Then, learner will call <code class="docutils literal notranslate"><span class="pre">LogShowHook</span></code> (<code class="docutils literal notranslate"><span class="pre">ding/ding/worker/learner/learner_hook.py</span></code>) to record those variables in a <code class="docutils literal notranslate"><span class="pre">TickMonitor</span></code> (<code class="docutils literal notranslate"><span class="pre">ding/ding/worker/learner/base_learner.py</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LogShowHook</span><span class="p">(</span><span class="n">LearnerHook</span><span class="p">):</span>

    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="s1">&#39;BaseLearner&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="c1"># ...</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">engine</span><span class="o">.</span><span class="n">log_buffer</span><span class="p">[</span><span class="s1">&#39;scalar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">monitor</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
<p>After that, <code class="docutils literal notranslate"><span class="pre">LogShowHook</span></code> will print variables. <code class="docutils literal notranslate"><span class="pre">LogShowHook</span></code> will call policy’s <code class="docutils literal notranslate"><span class="pre">_monitor_vars_learn</span></code> method to get all variables’ names, then get averaged value from <code class="docutils literal notranslate"><span class="pre">TickMonitor</span></code> and print them in text logger and tensorboard logger.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LogShowHook</span><span class="p">(</span><span class="n">LearnerHook</span><span class="p">):</span>

    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="s1">&#39;BaseLearner&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># noqa</span>
        <span class="c1"># ...</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">last_iter</span><span class="o">.</span><span class="n">val</span>
        <span class="k">if</span> <span class="n">iters</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">var_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">log_vars</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">policy</span><span class="o">.</span><span class="n">monitor_vars</span><span class="p">()</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;avg&#39;</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">log_vars</span><span class="p">:</span>
                <span class="n">k_attr</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attr</span>
                <span class="n">var_dict</span><span class="p">[</span><span class="n">k_attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">monitor</span><span class="p">,</span> <span class="n">attr</span><span class="p">)[</span><span class="n">k</span><span class="p">]()</span>
            <span class="n">engine</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_tabulate_vars_hor</span><span class="p">(</span><span class="n">var_dict</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">tb_logger</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;learner_iter/&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">tb_logger</span><span class="o">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s1">&#39;learner_step/&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">_collector_envstep</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="model_wrapper.html" class="btn btn-neutral float-right" title="How to Customize Model Wrapper" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="training_generated_folders.html" class="btn btn-neutral float-left" title="How to understand training generated folders?" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, OpenDILab Contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>